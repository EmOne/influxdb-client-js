<html>
  <head>
    <title>Influx DB JavaScript Client Example</title>
    <script type="module">
      import {InfluxDB, Point} from '../packages/core/dist/index.browser.mjs'

      /** InfluxDB v2 URL */
      const url = '' // rely upon proxy to forward to the target influxDB
      const token = 'my-token'
      const org = 'my-org'
      const bucket = 'my-bucket'

      const influxDB = new InfluxDB({url, token})

      // log results also to HTML page
      const logField = document.getElementById('log');
      function log(message, ...rest){
        console.log(arguments[0],rest)
        const previousValue = logField.value
        logField.value += (previousValue?'\n':'')+Array.prototype.slice.call(arguments).join('\n')
        // scroll to bottom with latest results
        logField.scrollTo(0,logField.scrollHeight <= logField.offsetHeight ? 0 : logField.scrollHeight-logField.offsetHeight)
      }

      function writeExample(value) {
        const writeApi = influxDB.getWriteApi(org, bucket)
        // setup default tags for all writes through this API
        writeApi.useDefaultTags({location: 'browser'})

        log('\n*** WRITE ***')
        const point1 = new Point('temperature')
          .tag('example', 'index.html')
          .floatField('value', value)
        writeApi.writePoint(point1)
        log(` ${point1}`)

        // flush pending writes and close writeApi
        writeApi
          .close()
          .then(() => {
            log('WRITE FINISHED')
            temperatureInput.value = String(20 + Math.round(100 * Math.random()) / 10)
          })
          .catch(e => {
            log('WRITE FAILED', e)
          })
      }
      function queryExample(fluxQuery) {
        log('\n*** QUERY ***')
        const queryApi = new InfluxDB({url, token}).getQueryApi(org)
        queryApi.queryRows(fluxQuery, {
          next(row, tableMeta) {
            const o = tableMeta.toObject(row)
            // log(JSON.stringify(o, null, 2))
            log(
              `${o._time} ${o._measurement} at '${o.location}': ${o._field}=${o._value}`
            )
          },
          error(error) {
            log('QUERY FAILED', error)
          },
          complete() {
            log('QUERY FINISHED')
          },
        })
      }

      // initialize page controls
      const temperatureInput = document.getElementById('temperature');
      temperatureInput.value = String(20 + Math.round(100 * Math.random()) / 10)
      const writeButton = document.getElementById('writeButton')
      writeButton.addEventListener('click', () => {
        const number = Number(temperatureInput.value)
        if (isNaN(number)) log('ERROR: Not a number '+temperatureInput.value);
        else writeExample(number)
      })
      const queryInput = document.getElementById('query');
      const queryButton = document.getElementById('queryButton')
      queryButton.addEventListener('click', () => {
        queryExample(queryInput.value)
      })

    </script>
  </head>
  <h1>Influx DB JavaScript Client Example</h1>
  <hr>
  <div>
    <input type="submit" id="writeButton" value='Write to InfluxDB'/>
    <span>Temperature: </span>
    <input type="number" id="temperature" value='20'></input>
  </div>
  <hr>
  <div style="display:flex; margin-bottom: 10px;">
    <textarea id="query" style="flex: 1" rows="2"
    >from(bucket:"my-bucket") |> range(start: 0) |> filter(fn: (r) => r._measurement == "temperature")</textarea>
  </div>
  <input type="submit" id="queryButton" value='Query InfluxDB'/>
  <hr>
  <fieldset>
    <legend>Log</legend>
    <textarea
      id="log"
      style="width: 100%"
      rows="25"
    ></textarea>
    <button onclick="document.getElementById('log').value=''">Clear Log</button>
  </fieldset>
</html>
